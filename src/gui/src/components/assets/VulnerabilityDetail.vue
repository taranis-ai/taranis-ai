<template>
    <div>
        <v-row justify="center">
            <v-dialog v-bind="UI.DIALOG.FULLSCREEN" v-model="visible"
                      @keydown.esc="cancel" report-item>
                <v-card>

                    <v-toolbar v-bind="UI.DIALOG.TOOLBAR" :style="UI.STYLE.z10000" data-dialog="report-item">
                        <v-btn icon dark @click="cancel" data-btn="cancel">
                            <v-icon>mdi-close-circle</v-icon>
                        </v-btn>
                        <v-toolbar-title>{{report_item.title}}</v-toolbar-title>
                    </v-toolbar>

                    <div style="padding:16px" class="div-wrapper">
                        <v-card style="margin-bottom: 8px" v-for="attribute_group in attribute_groups"
                                :key="attribute_group.id">

                            <v-card-title class="v-card-title-dialog">
                                {{attribute_group.title}}
                            </v-card-title>

                            <v-card-text style="padding-top:8px">
                                <AttributeContainer v-for="attribute_item in attribute_group.attribute_group_items"
                                                    :key="attribute_item.id"
                                                    :attribute_item="attribute_item" read_only></AttributeContainer>
                            </v-card-text>
                        </v-card>
                    </div>

                </v-card>
            </v-dialog>
        </v-row>
    </div>

</template>

<script>
    import AttributeContainer from "@/components/common/attribute/AttributeContainer";

    export default {
        name: "VulnerabilityDetail",
        components: {AttributeContainer},
        data: () => ({
            visible: false,
            report_types: [],
            attribute_groups: [],
            selected_type: null,
            report_item: {
                id: null,
                uuid: null,
                title: "",
                title_prefix: "",
                completed: false,
                report_item_type_id: null,
                news_item_aggregates: [],
                attributes: []
            }
        }),
        methods: {
            cancel() {
                this.visible = false;
            },
        },
        mounted() {
            this.$root.$on('show-vulnerability-detail', (data) => {
                this.visible = true;

                this.selected_type = null;
                this.attribute_groups = [];
                this.news_item_aggregates = data.news_item_aggregates;

                this.report_item.id = data.id;
                this.report_item.uuid = data.uuid;
                this.report_item.title = data.title;
                this.report_item.title_prefix = data.title_prefix;
                this.report_item.report_item_type_id = data.report_item_type_id;
                this.report_item.completed = data.completed;

                this.selected_type = data.report_item_type

                for (let i = 0; i < this.selected_type.attribute_groups.length; i++) {
                    let group = {
                        id: this.selected_type.attribute_groups[i].id,
                        title: this.selected_type.attribute_groups[i].title,
                        attribute_group_items: []
                    };

                    for (let j = 0; j < this.selected_type.attribute_groups[i].attribute_group_items.length; j++) {

                        let values = [];
                        for (let k = 0; k < data.attributes.length; k++) {
                            if (data.attributes[k].attribute_group_item_id === this.selected_type.attribute_groups[i].attribute_group_items[j].id) {

                                let value = data.attributes[k].value
                                if (this.selected_type.attribute_groups[i].attribute_group_items[j].attribute.type === 'CPE') {
                                    value = value.replace("%", "*")
                                }

                                values.push({
                                    index: values.length,
                                    value: value
                                });
                            }
                        }

                        group.attribute_group_items.push({
                            attribute_group_item: this.selected_type.attribute_groups[i].attribute_group_items[j],
                            values: values
                        })
                    }

                    this.attribute_groups.push(group)
                }
            });
        }
    }
</script>