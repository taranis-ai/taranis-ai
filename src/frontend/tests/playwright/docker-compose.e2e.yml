services:
  core:
    image: python:3.13-slim
    working_dir: /app
    command: >-
      sh -lc "python -m pip install --disable-pip-version-check --no-input --quiet uv &&
      uv sync --frozen --python 3.13 --no-install-project --no-install-package taranis-models &&
      uv pip install --python /tmp/.venv/bin/python --no-deps psycopg-binary &&
      /tmp/.venv/bin/python -m flask run --no-reload --host 0.0.0.0 --port 8080"
    environment:
      API_KEY: test_key
      JWT_SECRET_KEY: test_key
      FLASK_DEBUG: "1"
      DEBUG: "true"
      SQLALCHEMY_DATABASE_URI: sqlite:////tmp/taranis_ai_test.db
      QUEUE_BROKER_URL: memory://localhost
      PRE_SEED_PASSWORD_USER: test
      PRESERVE_CONTEXT_ON_EXCEPTION: "False"
      DISABLE_SSE: "true"
      SERVER_NAME: localhost
      TARANIS_CORE_SENTRY_DSN: ""
      DISABLE_SCHEDULER: "true"
      APPLICATION_ROOT: /
      GRANIAN_PORT: "8080"
      PYTHONPATH: /app:/models
      UV_PROJECT_ENVIRONMENT: /tmp/.venv
      UV_CACHE_DIR: /tmp/.cache/uv
    volumes:
      - "../../../core:/app"
      - "../../../models:/models"
    ports:
      - "5000:8080"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import urllib.request; urllib.request.urlopen(''http://127.0.0.1:8080/api/isalive'', timeout=2)"',
        ]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 5s
