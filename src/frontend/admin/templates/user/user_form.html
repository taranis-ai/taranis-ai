{% set error = error | default({}) %}
{% set create = request.path[-1:] == '0' | default('true') %}
{% set form_title = 'User' %}

{% set user = user
    | default({
        'id': '',
        'username': '',
        'name': '',
        'roles': [],
        'organization': '',
        '_errors': {}
    })
%}

{% set form_error = form_error | default({}) %}
{% set roles = roles | default([]) %}
{% set organizations = organizations | default([]) %}
<div class="bg-base-100 rounded-sm p-4 mt-4 wx-4/5 mx-auto">
    <div class="w-4/5 mx-auto">
    {% if create -%}
        <h1 class="text-3xl font-bold mb-5">Create {{ form_title }}</h1>
    {% else -%}
        {% include "user/edit_user.html" %}
    {% endif -%}
    </div>

    <form id="user-form" class="w-4/5 mx-auto" {% if create %}hx-post="/frontend/users"{% else %}hx-put="/frontend/users/{{ user.id }}"{% endif %} hx-swap="innerHTML"  hx-target="#form-container" hx-target-error="#form-container">
        {% if error.globalerror -%}
        <p class="text-3xl font-bold mb-4 error-msg">{{ error.globalerror }}</p>
        {% endif -%}

        <label class="floating-label mb-5 w-3/5">
            <span>Username</span>
            <input id="username" type="text" placeholder="Username" class="input w-3/5 validator {% if form_error.username %}input-error{% endif %}" name="username" required value="{{ user.username }}"/>
        </label>

        <label class="floating-label mb-5 w-3/5">
            <span>Name</span>
            <input type="text" placeholder="Name" class="input w-3/5 validator" name="name" required value="{{ user.name }}" id="userform_name" />
        </label>

        <div x-data="{ showPassword: false }" class="join gap-1 w-3/5">
          <label class="floating-label mb-5 input validator w-3/5">
              <span>Password</span>
                  <input
                      id="user-password"
                      :type="showPassword ? 'text' : 'password'"
                      placeholder="Password"
                      class="input input-md validator {% if form_error.password %}input-error{% endif %}"
                      name="password"
                      {% if create %}required hx-preserve{% endif %}
                  />
                  <div x-show="!showPassword" x-on:click="showPassword = !showPassword">{{ heroicon_solid("eye", class="h-5 w-5 cursor-pointer") }}</div>
                  <div x-show="showPassword" x-on:click="showPassword = !showPassword">{{ heroicon_solid("eye-slash", class="h-5 w-5 cursor-pointer") }}</div>
            </label>
          <button type="button" class="btn btn-primary" id="generate-password" onclick="document.getElementById('user-password').value = generatePassword();">Generate Password</button>
        </div>

        <div class="w-3/5">
        <label class="">
            <span>Roles</span>
        </label>
        <select name="roles[]" multiple required type="number" id="user-role-select">
            {% for role in roles %}
                <option value="{{ role.id }}" {% if role.id in user.roles %}selected{% endif %}>{{ role.name }} - {{ role.description | default(' ', true) | truncate(50, true) }}</option>
            {% endfor %}
        </select>
        <p class="validator-hint mb-5">Required</p>
        </div>
        <!-- organization -->
        <label class="floating-label mb-5 w-3/5">
            <span>Organization</span>
            <select name="organization" required type="number" class="validator select w-full">
                {% for organization in organizations -%}
                <option value="{{ organization.id }}" {% if organization.id == user.organization %}selected{% endif %}>{{ organization.name }}</option>
                {% endfor -%}
            </select>
            <p class="validator-hint">Required</p>
        </label>
        <div class="flex flex-wrap -mx-3 mb-6">
            <div class="w-full px-3">
              <input type="submit" class="btn btn-primary" value="{% if create %}Create{% else %}Update{% endif %} {{ form_title }}" />
            </div>
        </div>
    </form>

    {% if error|length > 1 %}
    <section id="status-msg">
        <div class="toast toast-top toast-end">
            <div class="alert alert-error">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span id="status-msg">{{ error }}</span>
                <svg onclick="return this.parentNode.remove();" class="inline w-4 h-4 fill-current ml-2 hover:opacity-80 cursor-pointer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                    <path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 464c-114.7 0-208-93.31-208-208S141.3 48 256 48s208 93.31 208 208S370.7 464 256 464zM359.5 133.7c-10.11-8.578-25.28-7.297-33.83 2.828L256 218.8L186.3 136.5C177.8 126.4 162.6 125.1 152.5 133.7C142.4 142.2 141.1 157.4 149.7 167.5L224.6 256l-74.88 88.5c-8.562 10.11-7.297 25.27 2.828 33.83C157 382.1 162.5 384 167.1 384c6.812 0 13.59-2.891 18.34-8.5L256 293.2l69.67 82.34C330.4 381.1 337.2 384 344 384c5.469 0 10.98-1.859 15.48-5.672c10.12-8.562 11.39-23.72 2.828-33.83L287.4 256l74.88-88.5C370.9 157.4 369.6 142.2 359.5 133.7z"/>
                </svg>
            </div>
        </div>
    </section>
    {% endif %}
</div>

<script>
  var settings = {
    plugins: ['remove_button'],
    persist:false,
    onItemAdd:function(){
			this.setTextboxValue('');
			this.refreshOptions();
		}};

  htmx.onLoad(function(elt) {

    var elt = document.getElementById('user-role-select');
    if (elt && elt.classList.contains('tomselected')) return;
    new TomSelect('#user-role-select', settings);
  });

  function generatePassword(
      length = 20,
      characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz~!@-#$'
    ) {
      return Array.from(crypto.getRandomValues(new Uint32Array(length)))
        .map((x) => characters[x % characters.length])
        .join('')
    }
</script>