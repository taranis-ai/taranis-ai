<!-- TODO:  THIS IS COMPLETLY NONSENSE UNVERIFIED JUST translated from UserInputForm.vue GPT -->


<div class="p-5" x-data="userImport()">
  <form id="form" hx-trigger="submit" hx-target="#result" @submit.prevent="submitForm">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
      <div>
        <label class="label">
          <span class="label-text">Select JSON File</span>
        </label>
        <input
          type="file"
          accept="application/json"
          class="file-input file-input-bordered w-full"
          @change="readJSONFile"
          required
        />
      </div>

      <div>
        <label class="label">
          <span class="label-text">Organization</span>
        </label>
        <select class="select select-bordered w-full" x-model="selectedOrganization" required>
          <option disabled value="">Select Organization</option>
          {% for org in organizations %}
            <option value="{{ org.id }}">{{ org.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="overflow-x-auto mt-5">
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for role in roles %}
            <tr>
              <td>
                <input type="checkbox" value="{{ role.name }}" x-model="selectedRoles" />
              </td>
              <td>{{ role.name }}</td>
              <td>{{ role.description }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <button type="submit" class="btn btn-success w-full mt-5">Submit</button>
  </form>

  <div id="result" class="mt-5"></div>
</div>

<script>
  function userImport() {
    return {
      selectedOrganization: '',
      selectedRoles: [],
      userList: [],

      readJSONFile(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = JSON.parse(e.target.result);
          this.userList = data.data;
          console.log(this.userList);
        };
        reader.readAsText(file);
      },

      submitForm() {
        if (!this.selectedOrganization || !this.selectedRoles.length || !this.userList.length) {
          alert('Please complete all required fields and select a valid JSON file.');
          return;
        }

        const payload = this.userList.map((user) => ({
          username: user.username,
          name: user.name,
          organization: this.selectedOrganization,
          roles: this.selectedRoles,
        }));

        fetch('/frontend/import/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ users: payload }),
        })
          .then((res) => res.text())
          .then((html) => (document.querySelector('#result').innerHTML = html))
          .catch((err) => alert('An error occurred: ' + err.message));
      },
    };
  }
</script>
