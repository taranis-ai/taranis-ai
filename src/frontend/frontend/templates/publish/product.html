{% extends "base.html" %}

{% block head %}<script src="{{ url_for('static', filename='vendor/js/fuse.js') }}"></script>{% endblock head %}

{% block content %}
{% from "macros/forms.html" import form_input, form_textarea, form_select %}
{% from "macros/datatable.html" import datatable %}

{% set form_error = form_error | default({}) %}
{% set product = product | default({}) %}

{% set product_types = product_types | default([]) %}

{# Build report items dataset for the datatable (filtered by selected product type's supported report types, if present) #}
{% set supported_reports = product.supported_reports | default([]) | tojson %}


{# Define columns for the datatable #}
{% set columns = [
  {"title": "id", "field": "id", "sortable": True, "searchable": True, "renderer": None},
  {"title": "title", "field": "title", "sortable": True, "searchable": True, "renderer": None},
  {"title": "created", "field": "created", "sortable": True, "searchable": False, "renderer": None},
  {"title": "completed", "field": "completed", "sortable": True, "searchable": False, "renderer": None},
] %}

{% set is_edit = (product.id is not none and product.id != 0) %}

<div class="p-6" id="product"
     x-data="{
        dirty: false,
        showPublish: false,
        showDirty: false,
        pendingAction: null,
        hasIncompleteReports: {{ has_incomplete_reports | default(false) | tojson }},
        renderedProduct: {{ (rendered_product | default('') | tojson) if rendered_product is defined else 'null' }},
        renderError: {{ (render_error | default('') | tojson) if render_error is defined else 'null' }},
        triggerAction(action) {
          if (this.dirty) {
            this.pendingAction = action; this.showDirty = true; return;
          }
          if (action === 'render') {
            const btn = document.getElementById('render-button'); if (btn) btn.click();
          } else if (action === 'publish') {
            this.showPublish = true;
          }
        },
        saveAndContinue() {
          this.showDirty = false;
          const form = document.getElementById('product-form');
          if (form) { form.requestSubmit(); }
        }
     }">
  <div class="card bg-base-100 shadow">
    <div class="card-body gap-3">
      <div class="flex items-center gap-3">
        <h2 class="card-title">
          {% if is_edit %}Edit product - {{ product.title }}{% else %}Create product{% endif %}
        </h2>
        <div class="flex-1"></div>
        {% if is_edit and rendered_product %}
          <a id="download-button"
             class="btn btn-outline"
             href="#" aria-label="Download"
             title="Download"
             data-testid="download-product"
             onclick="Swal.fire('Not wired yet', 'Add backend route to stream rendered product', 'info'); return false;">
            Download
          </a>
        {% endif %}
        <button type="button"
                class="btn btn-outline"
                @click="triggerAction('render')">
          Render
        </button>
        <button class="btn" :class="dirty ? 'btn-warning' : 'btn-success'" @click="document.getElementById('product-form').requestSubmit()">
          <span x-show="dirty" class="mr-1">!</span>
          Save
        </button>
      </div>

      <div class="grid grid-cols-12 gap-4">
        <div class="col-span-12 {% if is_edit %}lg:col-span-6{% else %}lg:col-span-12{% endif %}">
          <form id="product-form"
                class="px-2"
                {{ form_action }}
                hx-swap="innerHTML"
                hx-target="#form-container"
                hx-target-error="#form-container"
                @input="dirty=true">
            <div id="form-container">
              {% include "partials/admin_form_error.html" %}
              <div class="grid grid-cols-12 gap-4">
                <div class="col-span-12 md:col-span-6">
                  {{ form_select('Product Type', 'product_type_id', product.product_type_id, product_types, required=true, width='w-full', disabled=is_edit) }}
                </div>
                <div class="col-span-12 md:col-span-6">
                  {{ form_input('Title', 'title', product.title, form_error.title) }}
                </div>
                <div class="col-span-12">
                  {{ form_textarea('Description', 'description', product.description, form_error.description, required=false) }}
                </div>
              </div>

              {% if product.product_type_id %}
                <div class="mt-2">
                {{ supported_reports }}
                  {{ datatable('Report Items', supported_reports, columns, selected_items=product.report_items | default([]), input_name='report_items', headline='Report Items') }}
                </div>
              {% endif %}

              {% if is_edit %}
                <button type="button"
                        class="btn btn-primary mt-4 w-full"
                        :disabled="!renderedProduct"
                        @click="triggerAction('publish')">
                  <span x-show="renderedProduct">Publish</span>
                  <span x-show="!renderedProduct">Render Product first, to enable publishing</span>
                </button>
              {% endif %}

              <button id="render-button" type="button" class="hidden"
                      hx-post="/publish/products/{{ product.id | default('') }}/render"
                      hx-target="#product"
                      hx-swap="outerHTML">
                Render
              </button>
            </div>
          </form>

          {# Dirty Modal #}
          <dialog x-show="showDirty" class="modal" @click.outside="showDirty=false">
            <div class="modal-box">
              <h3 class="font-bold text-lg">Unsaved Changes</h3>
              <p class="py-4">You have unsaved changes. Do you want to save before continuing?</p>
              <div class="modal-action">
                <button class="btn" @click="showDirty=false">Cancel</button>
                <button class="btn btn-primary" @click="saveAndContinue()">Save and Continue</button>
              </div>
            </div>
          </dialog>

          {# Publish Modal #}
          <dialog x-show="showPublish" class="modal" @click.outside="showPublish=false">
            <div class="modal-box min-w-[28rem]">
              <h3 class="font-bold text-lg mb-2">Publish Product</h3>
              <div x-show="hasIncompleteReports" class="alert alert-warning mb-4">This Product contains incomplete Reports</div>
              <label class="select w-full">
                <span class="label">Publisher</span>
                {% set publisher_options = [] %}
                {% for p in publishers | default([]) %}
                  {% set _ = publisher_options.append({"id": p.id, "name": p.name}) %}
                {% endfor %}
                <select id="publisher_select" class="select w-full">
                  <option value="" selected disabled>Select a publisher</option>
                  {% for o in publisher_options %}
                    <option value="{{ o.id }}">{{ o.name }}</option>
                  {% endfor %}
                </select>
              </label>
              <div class="modal-action">
                <button class="btn" @click="showPublish=false">Abort</button>
                <button class="btn btn-primary"
                        :disabled="!document.getElementById('publisher_select') || !document.getElementById('publisher_select').value"
                        hx-post="/publish/products/{{ product.id | default('') }}/publishers/"
                        hx-vals='{ "publisher_id": document.getElementById("publisher_select") ? document.getElementById("publisher_select").value : "" }'
                        hx-target="#notification-bar"
                        hx-swap="outerHTML"
                        @htmx:afterRequest="showPublish=false">
                  Publish
                </button>
              </div>
            </div>
          </dialog>
        </div>

        {% if is_edit %}
        <div class="col-span-12 lg:col-span-6 p-3">
          <div class="border rounded-md p-3 bg-base-50 min-h-40" id="preview">
            {% if rendered_product %}
              {% if rendered_mime_type in ['text/html', 'application/json'] %}
                <div class="prose max-w-none" data-testid="html-render">{{ rendered_product | safe }}</div>
              {% elif rendered_mime_type == 'application/pdf' %}
                <object class="w-full h-[80vh]" data="data:application/pdf;base64,{{ rendered_product }}" type="application/pdf" data-testid="pdf-render"></object>
              {% elif rendered_mime_type == 'text/plain' %}
                <pre data-testid="text-render" class="whitespace-pre-wrap">{{ rendered_product }}</pre>
              {% elif rendered_mime_type == 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' %}
                <div class="alert">
                  Preview for .docx is not supported. Please download the file instead.
                </div>
              {% else %}
                <div class="alert">
                  Preview for {{ rendered_mime_type }} is not supported. Please download the file instead.
                </div>
              {% endif %}
            {% elif render_error %}
              <div class="text-center">
                <h2 class="text-xl mb-2">Failed to render Product</h2>
                <pre class="bg-base-200 p-2 rounded">{{ render_error }}</pre>
                <button class="btn btn-outline mt-4" @click="triggerAction('render')">Render</button>
              </div>
            {% else %}
              <div class="text-center">
                <h2 class="text-xl mb-2">No rendered Product Found</h2>
                <button class="btn btn-outline mt-2" @click="triggerAction('render')">Render</button>
              </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock content %}
