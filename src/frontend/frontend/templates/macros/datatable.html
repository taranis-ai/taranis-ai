{% macro datatable(table_id, data, columns, selected_items=[], selectable=true, input_name="selected_items") %}
{% from "macros/datatable.html" import datatable_header with context %}
{% set item_ids = data | map(attribute='id') | list %}

<div x-data="dataTable" x-init="init()">
<div>
  <h4 class="text-l font-bold mb-4">{{ table_id }}</h4>
  <input x-model.debounce="searchInput" type="text" class="w-full input" placeholder="Search..."/>
</div>
<table class="table table-sm" id="{{ table_id }}" >
    <thead>
        <tr>
            {% if selectable %}
            <th>
                <input type="checkbox"
                       class="checkbox"
                       @click="toggleSelectAll"
                />
            </th>
            {% endif %}

            {% for col in columns %}
                {{ datatable_header(col.title, col.sortable) }}
            {% endfor %}
        </tr>
    </thead>
    <tbody>
      <template x-for="(item, index) in items" :key="index">
        <tr x-show="checkView(index + 1)" class="hover:bg-gray-200 text-gray-900 text-xs">
        {% if selectable %}
        <td>
            <input type="checkbox" class="checkbox checkbox-sm" :value="item.id" x-model="selectedItems" />
        </td>
        {% endif %}

        {% for col in columns %}
        <td>
            <span x-text="item.{{ col.field }}"></span>
        </td>
        {% endfor %}
      </template>
      <tr x-show="isEmpty()">
        <td colspan="5" class="text-center py-3 text-gray-900 text-sm">No matching records found.</td>
      </tr>
    </tbody>
    <tfoot hx-target="#{{ table_id }}" hx-swap="outerHTML">
        <tr>
            <td colspan="{{ (columns|length + (1 if selectable else 0)) }}">
                <div class="flex justify-center">
                  <div class="flex items-center justify-between gap-8 bg-base-100 w-fit">
                    <div class="items-center gap-2">
                      <span class="text-sm font-medium">Items per page:</span>
                      <select name="limit" x-model="view" @change="changePage(1)" class="select select-bordered w-18">
                        {% set current_limit = request.args.get('limit', 5) %}
                        {% for option in [5, 20, 50, 100] %}
                        <option value="{{ option }}">
                          {{ option }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>

                    <!-- Pagination Buttons & Current Page -->
                    <div class="flex items-center gap-2">
                      <a class="btn btn-sm h-8" @click="changePage(1)">«</a>

                      <a class="btn btn-sm h-8" @click="changePage(pagination.currentPage - 1)">‹</a>

                      <span class="flex px-3 py-1 h-8 items-center bg-base-200 rounded-md text-sm font-semibold">
                        Page {{ data.current_page }} of {{ data.total_pages }}
                      </span>

                      <a class="btn btn-sm h-8" @click="changePage(pagination.currentPage + 1)">›</a>

                      <a class="btn btn-sm h-8" @click="changePage(pagination.lastPage)">»</a>
                    </div>
                  </div>
                </div>
            </td>
        </tr>
    </tfoot>
</table>
</div>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('dataTable', () => ({
    data: [
      {% for p in data %}
      {{ p| tojson(indent=2) | safe }}{% if not loop.last %},{% endif %}
      {% endfor %}
    ],

    items: [],
    selectedItems: [],
    selectedItemsCount: 0,
    view: 5,
    searchInput: '',
    pagination: {},
    fuse: null,
    searchKeys: {{ columns | selectattr('searchable') | map(attribute='field') | list | tojson }},

    init() {
      this.items = this.data
      this.pagination = {
        total: this.data.length,
        lastPage: Math.ceil(this.data.length / this.view),
        perPage: this.view,
        currentPage: 1,
        from: 1,
        to: this.view
      };
      this.fuse = new Fuse(this.data, { keys: this.searchKeys });
      this.$watch('searchInput', value => this.search(value));
      this.changePage(1)
    },
    search(value) {
      if (value.length > 1) {
        const result = this.fuse.search(value)
        this.items = result.map(elem => elem.item)
      } else {
        this.items = this.data
      }
      this.changePage(1)
    },
    checkView(index) {
      return index > this.pagination.to || index < this.pagination.from ? false : true
    },
    checkPage(item) {
      if (item <= this.pagination.currentPage + 5) {
        return true
      }
      return false
    },
    changePage(page) {
      if (page >= 1 && page <= this.pagination.lastPage) {
        const total = this.items.length
        const lastPage = Math.ceil(total / this.view) || 1
        const from = (page - 1) * this.view + 1
        let to = page * this.view
        if (page === lastPage) {
          to = total
        }
        this.pagination.total = total
        this.pagination.lastPage = lastPage
        this.pagination.perPage = this.view
        this.pagination.currentPage = page
        this.pagination.from = from
        this.pagination.to = to
      }
    },
    isEmpty() {
      return this.pagination.total ? false : true
    }

  }));
});
</script>
{% endmacro %}

{% macro datatable_header(title, sortable) %}
{% from "macros/query_params.html" import update_query_params with context %}
{% set order_direction = 'asc' if request.args.get('order') != title ~ '_asc' else 'desc' %}
{% set order = title ~ '_' ~ order_direction %}
{% set order_params = {'order': order, 'page': 1} %}
{% set order_url = update_query_params(order_params) %}
{% if sortable %}
<th>
  <a  @click="sort('{{ title }}', '{{ order_direction }}')"
      class="link link-hover">
      {{ title|capitalize }}
  </a>
</th>
{% else %}
  <th>{{ title|capitalize }}</th>
{% endif %}
{% endmacro %}

{% macro datatable_search_bar(table_id) %}
{% set current_search = request.args.get('search', '') %}
<div class="grow">
  <form
    hx-get="{{ request.path }}"
    hx-push-url="true"
    hx-target="#{{ table_id }}"
    hx-trigger="input delay:500ms"
  >
    <input
      type="search"
      name="search"
      class="input w-full"
      placeholder="Search..."
      value="{{ current_search }}"
    />
  </form>
</div>
{% endmacro %}
