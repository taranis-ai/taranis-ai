{% extends "base.html" %}
{% from 'dashboard/cards.html' import dashboard_card %}

{% block content %}
<div class="p-4" id="dashboard">
  <div class="text-3xl font-bold mb-4">Admin Dashboard</div>

  {% include "dashboard/user_item_cards.html" %}

  <div class="grid grid-flow-row-dense grid-cols-3 gap-4 mt-4">
    {% call dashboard_card('Connectors', '/connectors') %}
      There are <b>{{ data.conflict_count }}</b> conflicts detected.
    {% endcall %}

    {% call dashboard_card('Queue', url_for('admin.scheduler')) %}
      There are <b>{{ data.schedule_length }}</b> tasks scheduled.
      <br />
      Most recent News Item: <b>{{ data.latest_collected | format_datetime }}</b>
    {% endcall %}

    {% call dashboard_card('Release Info') %}
      Build date: <b>{{ build_info.get('build_date') | format_datetime }}</b>
    {% endcall %}

    {% for worker, stats in data.worker_status.items() %}
      {% set card_title = worker.split('_')[0] | capitalize %}
      {% call dashboard_card(card_title ~ ' Tasks', None) %}
        <div class="flex flex-col gap-1 text-sm">
          <div>
            <span class="badge badge-success">{{ stats.successes }}</span>
            <span class="ml-1">success</span>
          </div>
          <div>
            <span class="badge badge-error">{{ stats.failures }}</span>
            <span class="ml-1">failure</span>
          </div>

          <div class="mt-2 text-xs">Success rate: {{ stats.success_pct }}%</div>
          <div class="w-full h-2 rounded bg-base-300 overflow-hidden">
            <div class="h-full bg-success" style="width: {{ stats.success_pct }}%"></div>
          </div>
          <div class="mt-1 text-[0.7rem] text-base-content/60">
            Total: {{ stats.total }}
          </div>
        </div>
      {% endcall %}
    {% endfor %}
  </div>
</div>
{% endblock content %}
