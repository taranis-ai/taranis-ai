{% from "assess/story_card.html" import story_card with context %}
<div id="assess" data-testid="assess">
  {% set actions = actions | default([]) %}
  {% set pagination = pagination | default({}) %}

  <div
    id="assess-container"
    class="p-4"
    @keyup.escape.window="clearSelection()"
    {# djlint:off #}
    x-data='{
      selectedItems: [],
      showHints: false,
      allIds: {{ story_ids | default([]) | tojson }},
      toggleSelection(id) {
        if (this.selectedItems.includes(id)) {
          this.selectedItems = this.selectedItems.filter(item => item !== id);
        } else {
          this.selectedItems = [...this.selectedItems, id];
        }
      },
      isSelected(id) {
        return this.selectedItems.includes(id);
      },
      clearSelection() {
        this.selectedItems = [];
      },
      selectAll() {
        if (!this.allIds.length) return;
        this.selectedItems = [...this.allIds];
      },
      action_vals(action, value) {
        if (!action && !value) return JSON.stringify({ story_ids: this.selectedItems });
        return JSON.stringify({ story_ids: this.selectedItems, action: action, value: value });
      },
      openStoryEdit() {
        if (this.selectedItems.length !== 1) return;
        const storyId = this.selectedItems[0];
        const storyEditTemplate = "{{ url_for("assess.story_edit", story_id="__ID__") }}";
        const url = storyEditTemplate.replace("__ID__", storyId);
        window.location.href = url;
      }
    }'
    {# djlint:on #}
    >

    {% if stories %}
      {% include "assess/assess_top_bar.html" %}
      <div id="story-list">
        {% for story in stories %}{{ story_card(story) }}{% endfor %}
      </div>
      {% if pagination %}
        <div id="story-pagination"
             {% if request.headers.get("HX-Request") and pagination.infinite_scroll %}hx-swap-oob="outerHTML:#story-pagination"{% endif %}>
          {% if pagination.infinite_scroll %}
            {% include "assess/story_table_infinite_scroll.html" %}
          {% else %}
            {% include "assess/story_table_paging.html" %}
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <h2 class="text-center text-base-content/60 text-xl mb-4">No stories found.</h2>
      <a href="{{ routes.base_route }}" class="btn btn-primary w-full">
        {{ heroicon_outline('arrow-path', class='h-6 w-6') }}
        Reset filters
      </a>
    {% endif %}
  </div>
</div>
