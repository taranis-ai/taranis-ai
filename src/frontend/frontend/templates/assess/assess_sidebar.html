{% from 'assess/tri_state_filter.html' import tri_state_filter %}
{% set base_url = routes.base_route %}
{% set selected_groups = request.args.getlist('group') %}
{% set selected_sources = request.args.getlist('source') %}
{% set selected_tags = request.args.getlist('tags') %}
{% set current_search = request.args.get('search', '') %}
{% set current_limit = request.args.get('limit', 20) %}
{% set current_order = request.args.get('order', '') %}
{% set current_preset = request.args.get('range', '') %}
{% set time_from = request.args.get('timefrom', '') %}
{% set time_to = request.args.get('timeto', '') %}
{% set highlight = request.args.get('highlight') %}
{% set show_week_chart = request.args.get('show_week_chart') %}
{% set compact_view = request.args.get('compact_view') %}
{% set read_filter = request.args.get('read', '') %}
{% set important_filter = request.args.get('important', '') %}
{% set in_report_filter = request.args.get('in_report', '') %}
{% set relevant_filter = request.args.get('relevant', '') %}
{% set cybersecurity_filter = request.args.get('cybersecurity', '') %}
{% set source_groups = source_groups | default([]) %}
{% set sources = sources | default([]) %}
{% set available_tags = available_tags | default([]) %}
{% set sort_choices = sort_choices | default([
  {'label': 'Newest first', 'value': 'DATE_DESC'},
  {'label': 'Oldest first', 'value': 'DATE_ASC'},
  {'label': 'Most relevant', 'value': 'RELEVANCE_DESC'},
  {'label': 'Least relevant', 'value': 'RELEVANCE_ASC'}
]) %}
{% set quick_ranges = quick_ranges | default([
  {'label': 'Any', 'value': ''},
  {'label': 'Shift', 'value': 'shift'},
  {'label': 'Week', 'value': 'week'},
  {'label': '24h', 'value': '24h'}
]) %}
{% set tri_state_filters = [
  {'name': 'read', 'label': 'Read', 'value': read_filter},
  {'name': 'important', 'label': 'Important', 'value': important_filter},
  {'name': 'in_report', 'label': 'In Reports', 'value': in_report_filter},
  {'name': 'relevant', 'label': 'Relevant', 'value': relevant_filter}
] %}

<div class="p-4 space-y-6" id="assess-sidebar" hx-target-error="#notification-bar">
  <form id="assess-filter-form"
        class="space-y-6"
        hx-get="{{ base_url }}"
        hx-target="#assess"
        hx-select="#assess"
        hx-swap="outerHTML"
        hx-push-url="true"
        hx-target-error="#notification-bar"
        hx-trigger="change delay:250ms, keyup changed delay:500ms from:input[name='search'], submit">
    <input type="hidden" name="page" value="1">

    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-base-content/60">Search &amp; Scope</h3>
        <a href="https://taranis.ai/docs/assess/#details"
           target="_blank"
           rel="noopener"
           class="link link-hover text-xs text-base-content/60 inline-flex items-center">
          help
          {{ heroicon_outline('arrow-top-right-on-square', class='h-3 w-3') }}
        </a>
      </div>

      <label class="input input-bordered input-sm flex items-center gap-2">
        {{ heroicon_outline('magnifying-glass', class='h-4 w-4 text-base-content/70') }}
        <input type="search" name="search" value="{{ current_search }}" placeholder="Search stories" class="grow" autocomplete="off">
      </label>
    </section>

    <div class="divider text-xs">Source</div>
    <section class="space-y-4">
      <label class="form-control w-full">
        <span class="label-text text-xs font-medium uppercase text-base-content/70">Source group</span>
        <select name="group" class="select select-bordered select-sm">
          {% for group in source_groups %}
            <option value="{{ group.id }}" {% if group.id in selected_groups %}selected{% endif %}>{{ group.title or group.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="form-control w-full">
        <span class="label-text text-xs font-medium uppercase text-base-content/70">Source</span>
        <select name="source" class="select select-bordered select-sm">
          {% for source in sources %}
            <option value="{{ source.id }}" {% if source.id in selected_sources %}selected{% endif %}>{{ source.title or source.name }}</option>
          {% endfor %}
        </select>
      </label>
    </section>

    <div class="divider text-xs">Filter</div>
    <section class="space-y-4">
      <div>
        <span class="label-text text-xs font-medium uppercase text-base-content/70">Quick range</span>
        <div class="join join-vertical sm:join-horizontal mt-2 w-full" role="group" aria-label="Time presets">
          {% for preset in quick_ranges %}
            {% set is_active = current_preset == preset.value %}
            <label class="btn btn-sm join-item {% if is_active %}btn-primary{% else %}btn-outline{% endif %}">
              <input type="radio" name="range" value="{{ preset.value }}" class="hidden" {% if is_active %}checked{% endif %}>
              {{ preset.label }}
            </label>
          {% endfor %}
        </div>
      </div>
      <div class="grid grid-cols-1 gap-3">
        <label class="form-control w-full">
          <span class="label-text text-xs font-medium uppercase text-base-content/70">From</span>
          <input type="datetime-local" name="timefrom" value="{{ time_from }}" class="input input-bordered input-sm">
        </label>
        <label class="form-control w-full">
          <span class="label-text text-xs font-medium uppercase text-base-content/70">To</span>
          <input type="datetime-local" name="timeto" value="{{ time_to }}" class="input input-bordered input-sm">
        </label>
      </div>
    </section>

    <div class="divider text-xs">Status</div>
    <section class="space-y-3">
      {% for item in tri_state_filters %}{{ tri_state_filter(item) }}{% endfor %}
      <label class="select w-full">
        <span class="label">Cybersecurity</span>
        <select name="cybersecurity" class="select select-bordered select-sm">
          <option value="" {% if cybersecurity_filter in ['', None] %}selected{% endif %}>Any</option>
          {% for option in ['yes', 'no', 'mixed', 'incomplete'] %}
            <option value="{{ option }}" {% if cybersecurity_filter == option %}selected{% endif %}>{{ option|capitalize }}</option>
          {% endfor %}
        </select>
      </label>
    </section>

    <div class="divider text-xs">Sort</div>
    <section>
      <label class="select w-full">
        <span class="label">Order</span>
        <select name="order" class="select select-bordered select-sm">
          {% for option in sort_choices %}
            <option value="{{ option.value }}" {% if option.value == current_order %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
    </section>

    <div class="divider text-xs">Display</div>
    <section class="space-y-2">
      <label class="label cursor-pointer justify-start gap-3">
        <input type="checkbox" class="checkbox checkbox-sm" name="highlight" value="true" {% if highlight %}checked{% endif %}>
        <span class="label-text">Highlight keywords</span>
      </label>
      <label class="label cursor-pointer justify-start gap-3">
        <input type="checkbox" class="checkbox checkbox-sm" name="show_week_chart" value="true" {% if show_week_chart %}checked{% endif %}>
        <span class="label-text">Show charts</span>
      </label>
      <label class="label cursor-pointer justify-start gap-3">
        <input type="checkbox" class="checkbox checkbox-sm" name="compact_view" value="true" {% if compact_view %}checked{% endif %}>
        <span class="label-text">Compact view</span>
      </label>
    </section>

    <div class="divider"></div>
    <div class="space-y-3">
      <button type="button"
              class="btn btn-primary btn-sm w-full"
              name="action"
              value="reset"
              hx-get="{{ base_url }}"
              hx-target="#assess"
              hx-select="#assess"
              hx-swap="outerHTML"
              hx-push-url="true"
              hx-target-error="#notification-bar">
        {{ heroicon_outline('arrow-path', class='h-4 w-4') }}
        Reset filters
      </button>
      {% if routes.edit_route %}
        <a class="btn btn-secondary btn-sm w-full" href="{{ routes.edit_route }}">
          {{ heroicon_outline('pencil-square', class='h-4 w-4') }}
          Create new item
        </a>
      {% endif %}
    </div>
  </form>

  <div class="divider"></div>
  <a class="btn btn-ghost btn-sm w-full" href="{{ url_for("user.profile") }}#hotkeys" target="_blank" rel="noopener">
    {{ heroicon_outline('command-line', class='h-4 w-4') }}
    Show hotkeys
  </a>
</div>
