{% extends "base.html" %}

{% block content %}
  <h1 class="text-2xl font-bold p-6">News Item Conflicts</h1>

  <div id="newsitem-conflicts-wrapper" class="p-6 space-y-6">

    {% for incoming_story_id, conflict_group in grouped_conflicts.items() %}
      <details class="border rounded-lg bg-base-200 shadow">
        <summary class="p-4 bg-base-300 flex justify-between items-center cursor-pointer">
          <div>
            <h2 class="font-bold text-lg">Incoming Story — ID: {{ incoming_story_id }}</h2>
            <p class="text-sm opacity-70">{{ conflict_group.incoming_story.title or "Untitled" }}</p>
          </div>
          <span aria-hidden="true" class="text-xl select-none">▾</span>
        </summary>

        <div class="p-6 space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="border rounded-lg p-4 bg-base-100 shadow">
              <h3 class="font-semibold text-lg">Incoming Story</h3>
              <p class="text-xs opacity-70">ID: {{ incoming_story_id }}</p>
              <ul class="list-disc pl-6 mt-2 space-y-1">
                {% for item in conflict_group.incoming_story.news_items %}<li>{{ item.title }}</li>{% endfor %}
              </ul>
            </div>

            <div class="space-y-4">
              {% for internal in conflict_group.internal_stories %}
                {% set summary = internal.summary %}
                {% set unique_items = internal.unique_news_items or [] %}
                {% set unique_ids = unique_items | map(attribute='id') | list %}

                <div class="border rounded-lg p-4 bg-base-100 shadow">
                  <h3 class="font-semibold text-lg">Internal Story</h3>
                  <p class="text-xs opacity-70">ID: {{ internal.story_id }}</p>

                  {% if summary %}
                    <h4 class="font-semibold mt-3">
                      <a href="{{ url_for('assess.story', story_id=internal.story_id) }}" class="text-primary hover:underline">{{ summary.title }}</a>
                    </h4>
                    <ul class="list-disc pl-6 mt-3 space-y-1">
                      {% for item in summary.news_item_data %}<li>{{ item.title }}</li>{% endfor %}
                    </ul>
                  {% endif %}

                  <div class="flex flex-col md:flex-row justify-between mt-6 gap-4">

                    <button class="btn btn-error"
                            hx-ext="json-enc"
                            hx-encoding="json"
                            hx-put="{{ url_for('base.news_conflicts_put') }}"
                            hx-vals='{{ { "incoming_story_id": incoming_story_id, "resolving_story_id": incoming_story_id, "existing_story_ids": conflict_group.internal_stories | map(attribute="story_id") | list, "incoming_news_item_ids": incoming_ids[incoming_story_id] | list, "remaining_stories": remaining_stories | map(attribute="id") | list } | tojson | safe }}'
                            hx-target="#newsitem-conflicts-wrapper"
                            hx-swap="innerHTML">Take Incoming Story (Replace Local)</button>

                    <button class="btn btn-primary"
                            hx-ext="json-enc"
                            hx-encoding="json"
                            hx-post="{{ url_for('base.news_conflicts_post') }}"
                            hx-vals='{{ { "story_id": internal.story_id, "incoming_story_id": incoming_story_id, "news_items": unique_items, "resolved_conflict_item_ids": unique_ids, "existing_story_news_item_ids": internal.existing_news_item_ids or [], "remaining_stories": remaining_stories | map(attribute="id") | list } | tojson | safe }}'
                            hx-target="#newsitem-conflicts-wrapper"
                            hx-swap="innerHTML"
                            {% if not unique_items %}disabled aria-disabled="true"{% endif %}>Keep Local Story + Add Unique Items</button>

                  </div>

                  {% if unique_items %}
                    <p class="text-sm mt-3 text-success">
                      {{ unique_items | length }} unique news item{{ 's' if unique_items | length != 1 else '' }} ready to add.
                    </p>
                  {% else %}
                    <p class="text-sm mt-3 text-warning">No unique news items available for this story.</p>
                  {% endif %}
                </div>
              {% endfor %}
            </div>

          </div>
        </div>
      </details>

    {% endfor %}
  </div>
{% endblock content %}
