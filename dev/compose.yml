services:
  database:
    image: "postgres:${POSTGRES_TAG:-17-alpine}"
    ports:
      - "${TARANIS_DATABASE_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: "${DB_DATABASE:-taranis}"
      POSTGRES_USER: "${DB_USER:-taranis}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-supersecret}"
    command: ["postgres", "-c", "shared_buffers=${DB_SHARED_BUFFERS:-64MB}", "-c", "max_connections=${DB_MAX_CONNECTIONS:-1000}"]
    healthcheck:
      test: ["CMD-SHELL", "sh -c 'pg_isready -U ${DB_USER:-taranis} -d ${DB_DATABASE:-taranis}'"]
      interval: 10s
      timeout: 3s
      retries: 3
    volumes:
      - "database_data:/var/lib/postgresql/data"

  redis:
    image: "redis:8-alpine"
    ports:
      - "${TARANIS_REDIS_PORT:-6379}:6379"
    volumes:
      - "redis_data:/data"
    environment:
      - "REDIS_PASSWORD=${REDIS_PASSWORD:-supersecret}"
    command:
      [
        "redis-server",
        "--requirepass", "${REDIS_PASSWORD}",
        "--appendonly", "yes",
        "--dir", "/data"
      ]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      start_period: 10s
      timeout: 3s
      retries: 3

volumes:
  database_data:
  redis_data:
